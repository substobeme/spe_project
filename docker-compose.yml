version: '3.8'

services:
  training:
    container_name: training
    build:
      context: .
      dockerfile: Dockerfile.training
    volumes:
      - ./data:/app/data
      - ./models:/app/models 
    command: python train_service.py

  recognition:
    container_name: recognition
    build:
      context: .
      dockerfile: Dockerfile.recognition
    volumes:
      - ./models:/app/models
      - ./data:/app/data
      - ./db:/app/db
      - /tmp/.X11-unix:/tmp/.X11-unix
      - /tmp/.docker.xauth:/tmp/.docker.xauth:rw:rw
      - /home/${USER}/.Xauthority:/root/.Xauthority:rw
    depends_on:
      - training
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - XAUTHORITY=/tmp/.docker.xauth
      - QT_X11_NO_MITSHM=1
      - XAUTHORITY=/root/.Xauthority
      # Qt plugin and platform settings
      - QT_QPA_PLATFORM=offscreen
      - QT_PLUGIN_PATH=/usr/local/lib/python3.9/site-packages/cv2/qt/plugins
      - QT_QPA_PLATFORM_PLUGIN_PATH=/usr/local/lib/python3.9/site-packages/cv2/qt/plugins
      - OPENCV_VIDEOIO_PRIORITY_V4L2=0
    devices:
      - /dev/video0:/dev/video0
    tty: true
    stdin_open: true

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    ports:
      - "5002:5002"
    volumes:
      - ./db:/app/db
      - ./models:/app/models
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - recognition
    command: python app.py
